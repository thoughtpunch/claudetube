[← Documentation](../README.md)

# PRD: YouTube PO Token & SABR Streaming Support

**Status:** Draft
**Author:** Claude
**Created:** 2026-02-02
**Last Updated:** 2026-02-02
**Epic:** claudetube-35d

---

## Executive Summary

YouTube is systematically locking down third-party video access through three reinforcing mechanisms: the **SABR streaming protocol**, **PO (Proof of Origin) token enforcement**, and **JavaScript challenge complexity**. These changes have already broken older yt-dlp versions and will continue to break more clients over time.

claudetube currently works because yt-dlp `2026.01.31` uses the `android_vr` client (which doesn't require PO tokens) as its primary fallback. This is a **shrinking window** -- YouTube has already killed `ios_downgraded`, `tv_embedded`, and `android_sdkless` clients, and `android_vr` could be next.

This PRD covers the **future epic** for deep PO token and SABR support. The goal is to give users a documented, tested path to configure PO tokens when the zero-config fallback eventually stops working -- while being honest that **claudetube cannot bypass YouTube's authentication for them**.

> **User burden disclosure:** PO token setup requires the user to run additional software (a Node.js server or Docker container) and/or export browser cookies. claudetube can document the process and pass the right flags to yt-dlp, but the user must do the setup work themselves.

---

## Background

### What is SABR?

SABR (**Server-Based Adaptive Bit Rate**) is YouTube's proprietary streaming protocol that replaces traditional direct-URL downloads. ([yt-dlp #12482](https://github.com/yt-dlp/yt-dlp/issues/12482))

**Before SABR:** YouTube's Innertube player API returned `adaptiveFormats` with direct HTTPS URLs for each video/audio stream. yt-dlp downloaded these like any HTTP file.

**With SABR:** The API returns only a SABR endpoint URL (containing `sabr=1`). This endpoint uses protobuf-encoded request/response bodies with a custom handshake that standard HTTP downloaders cannot handle. PO tokens are embedded in the protobuf body, not as URL parameters.

**Rollout timeline:**
- **Feb 2025**: `web` client starts returning SABR-only formats ([#12482](https://github.com/yt-dlp/yt-dlp/issues/12482))
- **Apr 2025**: YouTube Music enforces SABR ([#13037](https://github.com/yt-dlp/yt-dlp/issues/13037))
- **May 2025**: yt-dlp begins developing native SABR downloader ([PR #13515](https://github.com/yt-dlp/yt-dlp/pull/13515))
- **Nov 2025**: External JS runtime formally announced as required ([#15012](https://github.com/yt-dlp/yt-dlp/issues/15012))
- **Jan 2026**: Broken clients removed (`ios_downgraded`, `tv_embedded`); `web_embedded` added as fallback ([yt-dlp 2026.01.31](https://github.com/yt-dlp/yt-dlp/releases/tag/2026.01.31))

**Current status (Feb 2026):** The native SABR downloader is in development in [PR #13515](https://github.com/yt-dlp/yt-dlp/pull/13515) and available in nightly/test builds. Stable yt-dlp **skips** SABR-only formats and falls back to clients that provide direct URLs.

### What are PO Tokens?

PO (Proof of Origin) tokens are client attestation tokens generated by platform-specific "guard" systems. ([yt-dlp PO Token Guide](https://github.com/yt-dlp/yt-dlp/wiki/PO-Token-Guide))

| Guard System | Platform | Clients |
|-------------|----------|---------|
| **BotGuard** | Web | `web`, `mweb`, `web_safari`, `web_music`, `web_creator` |
| **DroidGuard** | Android | `android` |
| **iOSGuard** | iOS | `ios` |

Tokens generated for one guard system **cannot** be used with clients from a different platform.

#### Three Types of PO Tokens

| Type | Scope | Lifetime | Purpose |
|------|-------|----------|---------|
| **GVS** (Google Video Server) | Session-bound | ~12+ hours, possibly days | Required for downloading actual video/audio streams |
| **Player** | Per-video | Single video | Required for Innertube player requests that return format URLs |
| **Subs** | Per-video | Single video | Required for subtitle/caption requests |

#### Session Binding

PO tokens are cryptographically tied to the user's session:

- **Logged out:** Bound to the `VISITOR_INFO1_LIVE` cookie (Visitor ID)
- **Logged in:** Bound to the Data Sync ID (first part of `DATASYNC_ID`)

This means **cookies and PO tokens must match** -- you can't use a token generated in one session with cookies from another.

### YouTube Client Enforcement Status (Feb 2026)

| Client | PO Token Required? | Formats | Notes |
|--------|-------------------|---------|-------|
| `android_vr` | **No** | HLS (m3u8) | **Current yt-dlp default.** YouTube Kids videos unavailable. |
| `tv` | **No** | May have DRM | Excessive requests may trigger blocks. |
| `tv_simply` | **No** | Limited | No account cookies support. |
| `tv_downgraded` | **No** | Limited | Default for authenticated free accounts. |
| `web_embedded` | **No** | Limited | Only embeddable videos. Fallback for `android_vr`. |
| `web` | **Yes** (GVS, Subs rolling) | SABR-only | Desktop browser. |
| `web_safari` | **Yes** (GVS, Subs rolling) | HLS exempt from GVS PO | HLS streams work without GVS token. |
| `mweb` | **Yes** (GVS) | DASH/HLS | Recommended for manual PO token use. |
| `android` | **Yes** (GVS or Player) | DASH | DroidGuard tokens. No cookie support. |
| `ios` | **Yes** (GVS or Player, rolling) | DASH | iOSGuard tokens. No cookie support. |

**Key exception:** YouTube Premium subscribers do NOT require GVS PO tokens on any client.

**Removed clients (broken):** `ios_downgraded`, `tv_embedded`, `android_sdkless`

### yt-dlp Default Client Selection (2026.01.31)

| Condition | Default Clients |
|-----------|----------------|
| Logged out, JS runtime available | `android_vr`, `web`, `web_safari` |
| Logged out, NO JS runtime | `android_vr` only |
| Logged in (free account) | `tv_downgraded`, `web`, `web_safari` |
| Logged in (Premium) | `tv_downgraded`, `web_creator`, `web` |

### What Happens Without PO Tokens (Error Messages)

Users see a cascade of warnings and errors:

```
WARNING: [youtube] Some web client https formats have been skipped as they
are missing a url. YouTube is forcing SABR streaming for this client.

[youtube] web client https formats require a GVS PO Token which was not
provided. They will be skipped as they may yield HTTP Error 403.

ERROR: unable to download video data: HTTP Error 403: Forbidden
```

In verbose mode (`-v`), the definitive indicator of no PO token support:
```
[pot] PO Token Providers: none
```

Typical failure progression:
1. SABR warning for `web` client (formats skipped)
2. SABR warning for `web_safari` client (formats skipped)
3. PO token warning for remaining clients (formats skipped)
4. Falls back to `android_vr` HLS formats
5. If `android_vr` also fails: `HTTP Error 403: Forbidden`

### Cookies Alone Are Not Sufficient

In 2026, **cookies alone do not guarantee access** ([#13968](https://github.com/yt-dlp/yt-dlp/issues/13968), [#14390](https://github.com/yt-dlp/yt-dlp/issues/14390)):

- **Premium with cookies:** GVS PO Token is not required (the one exception).
- **Free account with cookies:** PO tokens are still needed for GVS on most clients.
- **SABR complication:** Some Premium accounts have been flagged for SABR-only enforcement that cannot be bypassed.

The recommended stack for reliable YouTube downloads in 2026:
1. Latest yt-dlp (nightly recommended)
2. Deno JS runtime installed
3. PO Token provider plugin (bgutil) OR manual PO tokens
4. Cookies (from browser export)

---

## Current State (Stopgap Fix - Shipped)

The following mitigations are in place:

1. **Pinned `yt-dlp>=2026.01.15`** in `pyproject.toml`
2. **Upgraded venv yt-dlp to `2026.01.31`** (stable, with client fixes)
3. **System PATH passthrough** in `_subprocess_env()` so yt-dlp can find `deno`, `ffmpeg`, and other system tools
4. **`youtube:player_client=default,mweb`** as default extractor args for YouTube audio downloads
5. **Opt-in config passthrough** for `youtube.po_token` and `youtube.cookies_file`
6. **Combined error messages** when both first attempt and fallback fail
7. **`_run()` retries** on both `403` and `Requested format is not available` with alternative clients

**Why this works today:** yt-dlp `2026.01.31` defaults to `android_vr` (no PO token needed) for logged-out users. This provides HLS formats that work for most public videos.

**Why this will eventually break:** YouTube is systematically deprecating clients that don't require PO tokens. When `android_vr` gets blocked or restricted, users will need the full PO token stack.

---

## Design: Full PO Token Support

### Architecture

```
User's machine
  ├── claudetube config (.claudetube/config.yaml)
  │   └── youtube:
  │       ├── cookies_from_browser: "firefox"    # Option A: browser cookies
  │       ├── cookies_file: "~/yt-cookies.txt"   # Option B: exported cookies
  │       ├── po_token: "mweb.gvs+TOKEN..."      # Option C: manual token
  │       └── pot_server_url: "http://..."        # Option D: bgutil server URL
  │
  ├── claudetube (Python, in venv)
  │   └── YtDlpTool._run()
  │       ├── Builds yt-dlp args from config
  │       ├── Passes system PATH (deno, ffmpeg discoverable)
  │       └── subprocess.run(yt-dlp ..., env=system_PATH)
  │
  ├── yt-dlp (Python, in venv)
  │   ├── POT Provider plugin framework
  │   │   └── bgutil-ytdlp-pot-provider (pip-installed, auto-discovered)
  │   │       ├── HTTP provider (priority 130) → POSTs to bgutil server
  │   │       └── Script provider (priority 1)  → runs node generate_once.js
  │   ├── External JS runtime (deno) for n/sig solving
  │   └── Client selection: android_vr → web → web_safari → mweb
  │
  └── bgutil-ytdlp-pot-provider server (Node.js, user-managed)
      ├── Docker: brainicism/bgutil-ytdlp-pot-provider
      ├── Or native: node server/build/main.js (port 4416)
      ├── JSDOM + BotGuard JS interpreter (headless, no browser)
      └── Token cache (6hr TTL, IP-bound)
```

### Graceful Degradation Strategy

The system must work at every level of user configuration, falling back gracefully:

```
Level 4: bgutil server + cookies + deno    → All YouTube content works
Level 3: Manual PO token + cookies + deno  → Works but tokens expire (~12hr)
Level 2: Cookies only + deno               → Premium users: full access
                                             Free users: android_vr only
Level 1: Deno only (no cookies/tokens)     → android_vr HLS formats
Level 0: Nothing configured                → android_vr HLS (may break)
```

**Level 0 is where most claudetube users are today.** The goal of this epic is to document and support Levels 1-4, so users can move up when Level 0 stops working.

### Non-YouTube Sites (1,500+)

All PO token logic MUST be gated behind `_is_youtube_url()` checks. yt-dlp handles all other sites with its standard extractor system -- no PO tokens, no SABR, no special client args. The `--extractor-args "youtube:..."` flags are YouTube-specific and ignored by other extractors.

**Test requirement:** Every change must be verified against at least one non-YouTube site (e.g., Vimeo) to ensure no regression.

### bgutil-ytdlp-pot-provider Integration

[bgutil-ytdlp-pot-provider](https://github.com/Brainicism/bgutil-ytdlp-pot-provider) (v1.2.2, GPL-3.0) is a yt-dlp POT provider plugin that automates PO token generation.

**How it works:**
1. Installs into `yt_dlp_plugins/extractor/` namespace package
2. Uses `@register_provider` decorator to register with yt-dlp's POT framework
3. When yt-dlp needs a PO token, it calls the plugin automatically
4. Plugin communicates with a Node.js server (or spawns a Node.js script) that:
   - Fetches BotGuard challenge from YouTube
   - Runs the BotGuard interpreter JS in JSDOM (no real browser needed)
   - Generates an integrity token via Google's `GenerateIT` endpoint
   - Mints a PO token via `WebPoMinter.mintAsWebsafeString()`
5. Tokens cached with 6-hour TTL, IP-bound

**Two provider modes:**
| Mode | How it works | Priority | Recommended? |
|------|-------------|----------|-------------|
| HTTP Server | POSTs to `http://127.0.0.1:4416/get_pot` | 130 (preferred) | Yes |
| Script | Spawns `node generate_once.js` per invocation | 1 (fallback) | No (slow) |

**Server dependencies:**
- Node.js >= 18
- npm packages: `bgutils-js`, `jsdom`, `canvas`, `express`, `axios`, `youtubei.js`
- Docker image available: `brainicism/bgutil-ytdlp-pot-provider`

**Plugin dependencies:**
- Python package: `bgutil-ytdlp-pot-provider` (no Python deps beyond yt-dlp)
- yt-dlp >= 2025.05.22

**When working, verbose output shows:**
```
[debug] [youtube] [pot] PO Token Providers: bgutil:http-1.2.2 (external), bgutil:script-1.2.2 (external)
```

### Config Schema

```yaml
# .claudetube/config.yaml or ~/.config/claudetube/config.yaml

youtube:
  # --- Authentication (choose one or more) ---

  # Option A: Extract cookies directly from browser (yt-dlp built-in)
  # Supported: firefox, chrome, chromium, brave, edge, safari, opera, vivaldi
  # WARNING: Export from a private window, then close it to prevent rotation.
  # See: https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies
  cookies_from_browser: "firefox"

  # Option B: Netscape-format cookie file
  # Export using a browser extension or yt-dlp's --cookies-from-browser
  cookies_file: "~/.config/claudetube/youtube-cookies.txt"

  # Option C: Manual PO token (format: CLIENT.TYPE+TOKEN)
  # Generated via browser DevTools or BgUtils.
  # GVS tokens last ~12 hours. Player/Subs tokens are per-video.
  # See: https://github.com/yt-dlp/yt-dlp/wiki/PO-Token-Guide
  po_token: "mweb.gvs+TOKEN_VALUE_HERE"

  # --- bgutil PO Token Provider (optional, automates token generation) ---

  # Override the bgutil HTTP server URL (default: http://127.0.0.1:4416)
  # Only needed if running the server on a non-default host/port.
  pot_server_url: "http://127.0.0.1:4416"

  # Override the bgutil script path (only if not using HTTP server)
  # pot_script_path: "~/bgutil-ytdlp-pot-provider/server/build/generate_once.js"
```

**Priority order:** `cookies_from_browser` > `cookies_file` > `po_token`

All fields are optional. With nothing configured, claudetube relies on yt-dlp's default client selection (`android_vr`).

### User Messaging Strategy

#### On Download Success (no changes needed)
Silent. No warnings about PO tokens if the download works.

#### On 403 / Format-Not-Available After All Retries

```
Audio download failed for YouTube video.

YouTube is increasingly requiring authentication for video downloads.
If you're seeing this error frequently, you can configure YouTube
authentication in your claudetube config file.

For setup instructions, see:
  https://github.com/thoughtpunch/claudetube/blob/main/documentation/guides/youtube-auth.md

Quick fix options (easiest to hardest):
  1. Install deno: brew install deno (or https://deno.land)
  2. Add browser cookies to config
  3. Install bgutil PO token provider (automated)
  4. Generate a manual PO token (expires in ~12 hours)

Technical details:
  [First attempt] <original error>
  [Retry with default,mweb] <retry error>
```

#### On Partial Success (SABR warnings but download worked)

Log at DEBUG level only -- don't alarm the user if it worked:
```
DEBUG: YouTube SABR warning for web client, but download succeeded via android_vr
```

#### On Config Parse Error

```
WARNING: Failed to parse youtube config from .claudetube/config.yaml: <detail>
Continuing without YouTube authentication.
```

---

## Implementation Tickets

| ID | Title | Priority | Type | Deps |
|----|-------|----------|------|------|
| claudetube-35d | YouTube PO Token & SABR Streaming Support | P3 | Epic | -- |
| claudetube-5vi | Integrate bgutil-ytdlp-pot-provider plugin | P3 | Feature | Epic |
| claudetube-6m7 | Add YouTube cookie management to config | P3 | Feature | Epic |
| claudetube-4ds | Add PO token auto-refresh and health checks | P4 | Feature | Epic |
| claudetube-e65 | SABR protocol documentation and troubleshooting guide | P4 | Task | Epic |

### Ticket: Integrate bgutil-ytdlp-pot-provider (claudetube-5vi)

**What to build:**
1. Add optional dependency in `pyproject.toml`:
   ```toml
   youtube-pot = [
       "bgutil-ytdlp-pot-provider>=1.2.0",
   ]
   ```
2. Add `pot_server_url` config support in `_youtube_config_args()`:
   - Maps to `--extractor-args "youtubepot-bgutilhttp:base_url=URL"`
3. Add `pot_script_path` config support:
   - Maps to `--extractor-args "youtubepot-bgutilscript:script_path=PATH"`
4. Add detection: after install, verify plugin is loaded via verbose output parsing
5. Document installation in `documentation/guides/youtube-auth.md`

**Acceptance criteria:**
- `pip install claudetube[youtube-pot]` installs the plugin
- yt-dlp auto-discovers and uses the plugin
- Verbose output shows `PO Token Providers: bgutil:http-*`
- Non-YouTube sites unaffected

### Ticket: Add YouTube cookie management (claudetube-6m7)

**What to build:**
1. Add `cookies_from_browser` config support:
   - Maps to `--cookies-from-browser BROWSER`
2. Update `cookies_file` passthrough (already partially implemented):
   - Maps to `--cookies PATH`
3. Priority order: `cookies_from_browser` > `cookies_file`
4. Add to all YouTube download methods (audio, video segment, subtitles, thumbnails)
5. Warning when cookie file doesn't exist

**Important caveats to document:**
- Cookie export from private/incognito window recommended ([yt-dlp wiki](https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies))
- YouTube rotates cookies on open tabs -- close the browser after export
- `cookies_from_browser` requires the browser to NOT be running
- Cookies provide session identity that PO tokens bind to

### Ticket: PO token health checks (claudetube-4ds)

**What to build:**
1. New method `check_youtube_auth_status()` that:
   - Checks if deno is installed
   - Checks if bgutil plugin is loaded (via `--print "%(extractor)s"` verbose)
   - Checks if cookies are configured and valid
   - Returns structured status dict
2. Surface status in MCP tools (e.g., extend `get_analysis_status_tool`)
3. When download fails with 403 after all retries:
   - Log structured JSON with `auth_level`, `deno_available`, `plugin_loaded`
   - Include actionable URL to setup guide

### Ticket: SABR documentation guide (claudetube-e65)

**What to create:**

1. **`documentation/guides/youtube-auth.md`** -- User-facing setup guide:
   - What changed and why (SABR, PO tokens, in plain language)
   - Prerequisites: deno, Node.js (for bgutil)
   - Three setup paths: cookies-only, bgutil, manual tokens
   - Step-by-step for each path with exact commands
   - Troubleshooting section with exact error messages
   - Links to all upstream documentation

2. **Update README.md** Prerequisites section:
   - Add `deno` as recommended dependency for YouTube
   - Note about YouTube authentication
   - Link to `documentation/guides/youtube-auth.md`

3. **Update CLAUDE.md** Authentication Notes section:
   - Expand with YouTube-specific auth info
   - Link to guide

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|-----------|
| `android_vr` client gets blocked | Medium (6-12 months) | High -- zero-config YouTube breaks | This epic exists to provide the upgrade path before that happens |
| bgutil-ytdlp-pot-provider breaks | Medium | Medium | It's a yt-dlp plugin, not our code. Fallback to manual tokens. |
| YouTube changes BotGuard challenge | High (ongoing) | Low | bgutil maintainers track this actively |
| PO token requirement becomes universal | High (12-18 months) | High | Full bgutil integration provides automated handling |
| Users confused by setup complexity | High | Medium | Clear docs, actionable error messages, tiered difficulty |
| GPL-3.0 license concern (bgutil) | Low | Low | Optional dependency, not bundled. Users install separately. |

---

## Non-Goals (Explicit)

- **We will NOT bypass YouTube's authentication.** claudetube passes user-provided credentials to yt-dlp. We document the setup, we don't circumvent the protection.
- **We will NOT bundle or auto-install bgutil server.** The Node.js server is the user's responsibility. We document how to set it up.
- **We will NOT implement a native SABR downloader.** That's yt-dlp's job ([PR #13515](https://github.com/yt-dlp/yt-dlp/pull/13515)). We'll adopt it when it lands in stable.
- **We will NOT auto-generate PO tokens from within claudetube.** We pass config to yt-dlp, which delegates to its plugin system.

---

## References

### Primary Sources (upstream documentation)
- [yt-dlp PO Token Guide](https://github.com/yt-dlp/yt-dlp/wiki/PO-Token-Guide) -- Canonical reference for PO token types, client enforcement, manual extraction
- [yt-dlp Extractors Wiki: YouTube](https://github.com/yt-dlp/yt-dlp/wiki/Extractors) -- Client table, cookie export guide, visitor data
- [yt-dlp YouTube Extractor Args](https://github.com/yt-dlp/yt-dlp#youtube) -- CLI syntax for `--extractor-args`
- [bgutil-ytdlp-pot-provider](https://github.com/Brainicism/bgutil-ytdlp-pot-provider) -- Automated PO token plugin (v1.2.2)
- [BgUtils](https://github.com/LuanRT/BgUtils) -- BotGuard interfacing library used by bgutil
- [yt-dlp PO Token Provider Developer Docs](https://github.com/yt-dlp/yt-dlp/tree/master/yt_dlp/extractor/youtube/pot/README.md) -- Plugin API reference

### Tracking Issues
- [yt-dlp #12482](https://github.com/yt-dlp/yt-dlp/issues/12482) -- `web` client SABR-only formats (canonical SABR issue)
- [yt-dlp #13037](https://github.com/yt-dlp/yt-dlp/issues/13037) -- YouTube Music SABR enforcement
- [yt-dlp PR #13515](https://github.com/yt-dlp/yt-dlp/pull/13515) -- Native SABR downloader (in development)
- [yt-dlp #14404](https://github.com/yt-dlp/yt-dlp/issues/14404) -- Announcement: upcoming JS runtime requirement
- [yt-dlp #15012](https://github.com/yt-dlp/yt-dlp/issues/15012) -- Announcement: external JS runtime now required
- [yt-dlp #15601](https://github.com/yt-dlp/yt-dlp/pull/15601) -- Adjust default clients (Jan 2026)
- [yt-dlp 2026.01.31 release](https://github.com/yt-dlp/yt-dlp/releases/tag/2026.01.31) -- Current stable with client fixes

### Community Plugins
- [yt-dlp-pot-provider topic on GitHub](https://github.com/topics/yt-dlp-pot-provider) -- Discovery page for PO token plugins
- [YouTube Trusted Session Generator](https://github.com/iv-org/youtube-trusted-session-generator) -- Invidious project's approach
- [yt-dlp-ytse](https://github.com/coletdjnz/yt-dlp-ytse) -- Experimental SABR downloader plugin

### Cookie Export Guides
- [yt-dlp: Exporting YouTube Cookies](https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies)
- [yt-dlp: Passing Visitor Data Without Cookies](https://github.com/yt-dlp/yt-dlp/wiki/Extractors#passing-visitor-data-without-cookies) (not recommended)

---

## Success Criteria

1. **Level 0 continues working** until `android_vr` is blocked (no user action needed)
2. **Level 1-4 documented** with step-by-step guides in `documentation/guides/youtube-auth.md`
3. **`pip install claudetube[youtube-pot]`** installs bgutil plugin and it auto-activates
4. **Config-driven auth** works for cookies, manual PO tokens, and bgutil server URL
5. **Error messages are actionable** -- tell the user exactly what to do, with links
6. **Non-YouTube sites** (1,500+) are completely unaffected by any changes
7. **No secrets in config examples** -- all docs use placeholder values
